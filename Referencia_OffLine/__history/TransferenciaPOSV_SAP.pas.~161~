unit TransferenciaPOSV_SAP;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, CustomModule, Menus, StdActns, ActnList, StrUtils, JvComponentBase,
  JvFormPlacement, ExtCtrls, JvExControls, JvComponent, JvEnterTab,
  dxLayoutControl, cxControls, cxPC, cxStyles, cxCustomData, cxGraphics,
  cxFilter, cxData, cxDataStorage, cxEdit, DB, cxDBData, cxLookAndFeelPainters,
  StdCtrls, cxButtons, cxDBEdit, cxGridLevel, cxClasses, cxGridCustomView,
  cxGridCustomTableView, cxGridTableView, cxGridDBTableView, cxGrid, cxMaskEdit,
  cxDropDownEdit, cxCalendar, cxContainer, cxTextEdit, ADODB, cxImageComboBox,
  cxCheckBox, cxTimeEdit,cxDbLookupComboBox,cxDBExtLookupComboBox,cxSpinEdit,
  cxMemo, DateUtils, cxBlobEdit, cxintl, cxGroupBox, cxRadioGroup,
  cxCurrencyEdit, JvMemoryDataset, LMDCustomControl, LMDCustomPanel,
  LMDCustomBevelPanel, LMDSimplePanel,dlgmensajes, cxCheckGroup;

type
  TfrmTransferenciaPOSV_SAP = class(TfrmCustomModule)
    dxLayoutControl1Group_Root: TdxLayoutGroup;
    dxLayoutControl1: TdxLayoutControl;
    dxLayoutControl1Group1: TdxLayoutGroup;
    dxLayoutControl1Group2: TdxLayoutGroup;
    cxPageControl1: TcxPageControl;
    dxLayoutControl1Item1: TdxLayoutItem;
    cxTabSheet1: TcxTabSheet;
    dxLayoutControl2Group_Root: TdxLayoutGroup;
    dxLayoutControl2: TdxLayoutControl;
    dxLayoutControl2Group1: TdxLayoutGroup;
    dxLayoutControl2Group2: TdxLayoutGroup;
    dxLayoutControl2Group3: TdxLayoutGroup;
    cxGrid1DBTableView1: TcxGridDBTableView;
    cxGrid1Level1: TcxGridLevel;
    cxGrid1: TcxGrid;
    dxLayoutControl2Item4: TdxLayoutItem;
    BtFunciones: TcxButton;
    dxLayoutControl1Item4: TdxLayoutItem;
    cxGridStyles: TcxStyleRepository;
    stGrDatos: TcxStyle;
    stGrEdit: TcxStyle;
    dxLayoutControl2Group4: TdxLayoutGroup;
    cxGrid2DBTableView2: TcxGridDBTableView;
    cxGrid2Level1: TcxGridLevel;
    cxGrid2: TcxGrid;
    dxLayoutControl2Item9: TdxLayoutItem;
    dxLayoutControl2Item12: TdxLayoutItem;
    cboEstado: TcxComboBox;
    dsDatos: TDataSource;
    JvMemoryData1: TJvMemoryData;
    JvMemoryData1Seleccionar: TBooleanField;
    JvMemoryData1Pedido_Venta: TStringField;
    JvMemoryData1Cuenta_Cliente: TStringField;
    JvMemoryData1Nombre: TStringField;
    JvMemoryData1Tipo_Pedido: TStringField;
    JvMemoryData1Estado: TStringField;
    JvMemoryData1MonedaID: TStringField;
    cxGrid1DBTableView1Seleccionar: TcxGridDBColumn;
    cxGrid1DBTableView1Pedido_Venta: TcxGridDBColumn;
    cxGrid1DBTableView1Cuenta_Cliente: TcxGridDBColumn;
    cxGrid1DBTableView1Nombre: TcxGridDBColumn;
    cxGrid1DBTableView1Tipo_Pedido: TcxGridDBColumn;
    cxGrid1DBTableView1Estado: TcxGridDBColumn;
    cxGrid1DBTableView1MonedaID: TcxGridDBColumn;
    JvMemoryData2: TJvMemoryData;
    dsArticulos: TDataSource;
    JvMemoryData2PruebaID: TStringField;
    JvMemoryData2SucursalID: TStringField;
    JvMemoryData2Cantidad: TIntegerField;
    JvMemoryData2Unidad: TStringField;
    JvMemoryData2Precio_Unitario: TCurrencyField;
    JvMemoryData2Descuento: TCurrencyField;
    JvMemoryData2Neto: TCurrencyField;
    JvMemoryData2Descripcion: TStringField;
    JvMemoryData2Muestrano: TStringField;
    JvMemoryData2Nota_Debito: TBooleanField;
    JvMemoryData2Porcentaje_Desc: TCurrencyField;
    cxGrid2DBTableView2PruebaID: TcxGridDBColumn;
    cxGrid2DBTableView2SucursalID: TcxGridDBColumn;
    cxGrid2DBTableView2Cantidad: TcxGridDBColumn;
    cxGrid2DBTableView2Unidad: TcxGridDBColumn;
    cxGrid2DBTableView2Precio_Unitario: TcxGridDBColumn;
    cxGrid2DBTableView2Descuento: TcxGridDBColumn;
    cxGrid2DBTableView2Porcentaje_Desc: TcxGridDBColumn;
    cxGrid2DBTableView2Neto: TcxGridDBColumn;
    cxGrid2DBTableView2Descripcion: TcxGridDBColumn;
    cxGrid2DBTableView2Muestrano: TcxGridDBColumn;
    qrPedido: TADOQuery;
    qrPedidoClienteID: TStringField;
    qrPedidoMonedaID: TStringField;
    qrPedidoEstado: TStringField;
    qrPedidoU_Numero: TStringField;
    qrPedidoDetalle: TADOQuery;
    qrPedidoNombreCliente: TStringField;
    btProforma: TcxButton;
    dxLayoutControl1Item5: TdxLayoutItem;
    btConsulta: TcxButton;
    dxLayoutControl1Item3: TdxLayoutItem;
    MenuFunciones: TPopupMenu;
    CargarPedidodeVenta1: TMenuItem;
    TransferirPedidoSAP1: TMenuItem;
    BorrarPedido1: TMenuItem;
    spMensaje: TLMDSimplePanel;
    Shape1: TShape;
    Label1: TLabel;
    Panel1: TPanel;
    qrPedidoDetalleRecID: TLargeintField;
    qrPedidoDetallePruebaID: TStringField;
    qrPedidoDetalleMuestrano: TStringField;
    qrPedidoDetalleDescripcion: TStringField;
    qrPedidoDetallePrecio: TBCDField;
    qrPedidoDetalleDeptoPrue: TStringField;
    qrPedidoDetalleSucursalID: TStringField;
    qrPedidoDetalleCantidad: TIntegerField;
    qrPedidoDetalleUnidad: TStringField;
    qrPedidoDetalleDescuento: TBCDField;
    qrPedidoDetalleDescuento_Porcentaje: TBCDField;
    qrPedidoDetallePrecio_Unitario: TBCDField;
    qrPedidoClienteID_Gen: TStringField;
    qrPedidoGrupoID_Gen: TStringField;
    JvMemoryData1GrupoID_Gen: TStringField;
    JvMemoryData1ClienteID_Gen: TStringField;
    qrPedidoFecha_Desde: TDateTimeField;
    qrPedidoFecha_Hasta: TDateTimeField;
    JvMemoryData1Fecha_Inicio: TDateTimeField;
    JvMemoryData1Fecha_Fin: TDateTimeField;
    MenuPedido: TPopupMenu;
    MenuArticulo: TPopupMenu;
    AadirPedido1: TMenuItem;
    BorrarPedido2: TMenuItem;
    InsertarPrueba1: TMenuItem;
    EliminarPrueba1: TMenuItem;
    MarcarTodosRegistros1: TMenuItem;
    DesmarcarTodosRegistros1: TMenuItem;
    MenuProforma: TPopupMenu;
    Factura: TMenuItem;
    MenuConsultas: TPopupMenu;
    DetalleFacturacion: TMenuItem;
    ImprimirDetalleTodos1: TMenuItem;
    qrPedidoComentario: TStringField;
    JvMemoryData1Comentario: TStringField;
    cxGrid1DBTableView1Comentario: TcxGridDBColumn;
    JvMemoryData2RecID: TLargeintField;
    CancelarAgregarUsuario1: TMenuItem;
    JvMemoryData1RecID: TLargeintField;
    qrPedidoDetalleNeto: TCurrencyField;
    qrPedidoSeleccionar: TBooleanField;
    qrPedidoTipo_Pedido: TStringField;
    qrPedido_Head: TADOQuery;
    dsPedidoHead: TDataSource;
    qrPedido_HeadID: TGuidField;
    qrPedido_HeadU_Numero: TStringField;
    qrPedido_HeadGrupoID: TStringField;
    qrPedido_HeadClienteID: TStringField;
    qrPedido_HeadNombreCliente: TStringField;
    qrPedido_HeadTipo_Pedido: TStringField;
    qrPedido_HeadEstado: TStringField;
    qrPedido_HeadFecha_Desde: TDateTimeField;
    qrPedido_HeadFecha_Hasta: TDateTimeField;
    qrPedido_HeadComentario: TStringField;
    qrPedido_HeadSeleccionar: TBooleanField;
    qrPedido_HeadMonedaID: TStringField;
    procedure qrPedidoDetalleCalcFields(DataSet: TDataSet);
    procedure CancelarAgregarUsuario1Click(Sender: TObject);
    procedure InsertarPrueba1Click(Sender: TObject);
    procedure DesmarcarTodosRegistros1Click(Sender: TObject);
    procedure MarcarTodosRegistros1Click(Sender: TObject);
    procedure EliminarPrueba1Click(Sender: TObject);
    procedure BorrarPedido2Click(Sender: TObject);
    procedure cboEstadoPropertiesChange(Sender: TObject);
    procedure cxGrid1DBTableView1CellClick(Sender: TcxCustomGridTableView;
      ACellViewInfo: TcxGridTableDataCellViewInfo; AButton: TMouseButton;
      AShift: TShiftState; var AHandled: Boolean);
    procedure TransferirPedidoSAP1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure EdPacienteDblClick(Sender: TObject);
    procedure EdClienteDblClick(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure FormCreate(Sender: TObject);
  protected
    procedure SetColorTo(iColor: TColor);
  private
    { Private declarations }
    Cancelada         : TcxStyle;
    Facturada         : TcxStyle;
    Normal            : TcxStyle;
    Seleccion         : String;
  public
    { Public declarations }
    _doctor       : String;
    _poliza       : String;
    _muestra      : String;
    _entrada      : String;
    _recordId     : Integer;

    Function ActPreFacturaSap : Boolean;
    Function  Get_Estado(Estado : String) : String;    
    Function  Busca_RecID(ClienteID : String; Estado: String) : Int64;
    Function  Buscar_Pedidos(TipoPedido : String) : Boolean;
    procedure Buscar_Registro_Primario;
  end;

var
  frmTransferenciaPOSV_SAP       : TfrmTransferenciaPOSV_SAP;

implementation

uses ActionsDM, cxExportGrid4Link, DataModule, Main;

{$R *.dfm}


procedure TfrmTransferenciaPOSV_SAP.FormCreate(Sender: TObject);
begin
  inherited;
  frmMain.Tran_fer := True;
  Buscar_Pedidos('T');
  Buscar_Registro_Primario;
end;


procedure TfrmTransferenciaPOSV_SAP.FormDestroy(Sender: TObject);
begin
  inherited;
  frmMain.Tran_fer := False;
end;


procedure TfrmTransferenciaPOSV_SAP.FormShow(Sender: TObject);
begin
  inherited;
  If (dm.DBSAP.Connected = False) Then
  begin
    dm.DBSAP.Close;
    dm.DBSAP.Open;
  end;
  DM.qrPruebas.Close;
  With DM.qrPruebas, sql do
  begin
    Close;
    Clear;
    Add('SELECT ItemCode as PRUEBAID, ALIAS, DESCRIPCION, ESTATUS, GRUPOPRUEBAID, DEPARTAMENTO, PRECIO,');
    Add(' PERMITECAMBIOPRECIO, CODIGOAXAPTA, PRECIODOLARES, COSTO, EXTERIOR, FACTURARCABECERA, PRUEBAS,');
    Add(' TIPO, ORINA, SANGRE, CONDPACIENTE, CONDMUESTRA, CODDIAPROC, DIASRESULTADO, UNIDAD, ABREVIACION,');
    Add(' MEDIO, COLOR, DEPID, TIPOAS400, CODIGOIDAS400, MEDIOAS400, NOPROCESAR, COMENTARIONOPROCESAR, TIPOMUESTRA, COMENTARIO_REQ, COD_SEC_PRUEBA, SEXO, AYUNA, FONT_BOLD, CLIENTEID, DATAAREAID, RECID, TRANSFER FROM PTPrueba (nolock) Where Estatus = '+#39+'1'+#39);
    Open;
  end;
  DM.qrSucursal.Close;
  With DM.qrSucursal, sql do
  begin
    Close;
    Clear;
    Add('SELECT * FROM PtSucursal (nolock) Where sucursal > 0 ');
    Open;
  end;

  cboEstado.ItemIndex := 1;
  Cancelada             := TcxStyle.Create(Self);
  Facturada             := TcxStyle.Create(Self);
  Normal                := TcxStyle.Create(Self);
  Cancelada.Font.Color  := clWhite;
  Cancelada.TextColor   := clRed;
  Facturada.Font.Color  := clWhite;
  Facturada.TextColor   := clBlue;
  Normal.Font.Color     := clWhite;
  Normal.TextColor      := clBlack;
  cboEstado.SetFocus;
end;

procedure TfrmTransferenciaPOSV_SAP.InsertarPrueba1Click(Sender: TObject);
Var Estado : String;
begin
  inherited;
   Estado := Get_Estado(qrPedidoEstado.AsString);
   if qrPedidoDetalle.IsEmpty then
   begin
      qrPedidoDetalle.Active := true;
      qrPedidoDetalle.Delete;
   end;
   qrPedidoDetalle.Append;
   qrPedidoDetalleRecID.Value               := Busca_RecID(qrPedido_HeadClienteID.AsString,Estado);
   qrPedidoDetallePruebaID.Value            := 'SER00792';
   qrPedidoDetalleSucursalID.Value          := 'SP';
   qrPedidoDetalleCantidad.Value            := 1;
   qrPedidoDetalleUnidad.Value              := 'UND';
   qrPedidoDetallePrecio.Value              := 0.00;
   qrPedidoDetalleDescuento.Value           := 0.00;
   qrPedidoDetalleDescuento_Porcentaje.Value := 0.00;
   qrPedidoDetallePrecio_Unitario.Value     := 0.00;
   qrPedidoDetalleMuestrano.Value           := EmptyStr;
   qrPedidoDetalleDescripcion.Value         := 'Facturacion POS';
   qrPedidoDetalle.Post;
//   cxGrid2DBTableView2.OptionsView.NewItemRow := True;

{ if JvMemoryData2.IsEmpty then
   begin
      JvMemoryData2.Active := true;
      JvMemoryData2.EmptyTable;
   end;
   JvMemoryData2.Append;
   cxGrid2DBTableView2.OptionsView.NewItemRow := True;
   }
end;

procedure TfrmTransferenciaPOSV_SAP.MarcarTodosRegistros1Click(Sender: TObject);
begin
  inherited;
  if qrPedido_Head.Recordset.RecordCount > 0 then
  begin
        spMensaje.Visible :=True;
        qrPedido_Head.First;
        While Not qrPedido_Head.Eof do
        begin
            qrPedido_Head.Edit;
            qrPedido_HeadSeleccionar.Asboolean := True;
            qrPedido_Head.Post;
            qrPedido_Head.Next;
        end;
        qrPedido_Head.First;
        qrPedido_Head.Refresh;
        spMensaje.Visible :=False;
  end;
end;

procedure TfrmTransferenciaPOSV_SAP.qrPedidoDetalleCalcFields(
  DataSet: TDataSet);
begin
  inherited;
  qrPedidoDetalleNeto.Value := (qrPedidoDetallePrecio_Unitario.Value * qrPedidoDetalleCantidad.Value)-(qrPedidoDetalleDescuento.value);
end;

procedure TfrmTransferenciaPOSV_SAP.EdClienteDblClick(Sender: TObject);
begin
  inherited;
  frmMain.LanzaVentana(-7996);
end;


procedure TfrmTransferenciaPOSV_SAP.EdPacienteDblClick(Sender: TObject);
begin
  inherited;
{  frmMain.LanzaVentana(-7999);
  if (cboEstado.Text <> '') then
    Buscar_Ordenes_Abiertas;
}
end;


procedure TfrmTransferenciaPOSV_SAP.EliminarPrueba1Click(Sender: TObject);
Var qArticulo : TAdoQuery;
    DPrueba   : String;
begin
  inherited;
  if ( qrPedido_Head.RecordCount > 0) And
     ((qrPedido_HeadEstado.AsString='Abierto') Or (qrPedido_HeadEstado.AsString='T') Or
     (qrPedido_HeadEstado.AsString='Pre-Factura') Or (qrPedido_HeadEstado.AsString='P')) And
     (qrPedidoDetallePruebaID.AsString <> EmptyStr) Then
  begin
     If (EtMensajeDlg('Está seguro de eliminar este servicio '+qrPedidoDetallePruebaID.AsString+' Entrada='+qrPedidoDetalleMuestrano.AsString,etConfirmacion,[etSi,etNo],1,dm.Imagenes.Items[5].Bitmap,true) = mryes) then
     begin
          DPrueba := qrPedidoDetallePruebaID.AsString;
          spMensaje.Visible :=True;
          qrPedido.First;
          qArticulo := DM.NewQuery;
          qArticulo.Close;
          qArticulo.SQL.Text := ' Delete [SERSAP].POSInterfaz.dbo.PedidoVentaDetalle '+
                                ' Where RecID='+qrPedidoDetalleRecID.AsString+' And PruebaID ='+#39+qrPedidoDetallePruebaID.AsString+#39;
          qArticulo.ExecSQL;
          Buscar_Pedidos(Get_Estado(qrPedido_HeadEstado.AsString));
          Buscar_Registro_Primario;
          spMensaje.Visible := False;
          ShowMessage('Articulo '+ DPrueba+' Eliminado.  Verifique.');
     end;
     FreeAndNil(qArticulo);
  end;
end;

procedure TfrmTransferenciaPOSV_SAP.SetColorTo(iColor: TColor);
var
  i : Integer;
  oColor : TColor;
begin
  //SetComponentsColor(iColor);
  stGrEdit.Color := iColor;

  oColor := DM.ColorConsulta;
  for i := 0 to ComponentCount -1 do begin
    if ( Components[i] is TcxDbMaskEdit ) then begin
      if ( Components[i] as TcxDbMaskEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbMaskEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbMaskEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbComboBox ) then begin
      if ( Components[i] as TcxDbComboBox ).Properties.ReadOnly then
        ( Components[i] as TcxDbComboBox ).Style.Color := oColor
      else
        ( Components[i] as TcxDbComboBox ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbButtonEdit ) then begin
      if ( Components[i] as TcxDbButtonEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbButtonEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbButtonEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDBMRUEdit ) then begin
      if ( Components[i] as TcxDBMRUEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDBMRUEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDBMRUEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbTextEdit ) then begin
      if ( Components[i] as TcxDbTextEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbTextEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbTextEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbLookupComboBox ) then begin
      if ( Components[i] as TcxDbLookupComboBox ).Properties.ReadOnly then
        ( Components[i] as TcxDbLookupComboBox ).Style.Color := oColor
      else
        ( Components[i] as TcxDbLookupComboBox ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDBExtLookupComboBox ) then begin
      if ( Components[i] as TcxDBExtLookupComboBox ).Properties.ReadOnly then
        ( Components[i] as TcxDBExtLookupComboBox ).Style.Color := oColor
      else
        ( Components[i] as TcxDBExtLookupComboBox ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbCheckBox ) then begin
      if ( Components[i] as TcxDbCheckBox ).Properties.ReadOnly then
        ( Components[i] as TcxDbCheckBox ).Style.Color := oColor
      else
        ( Components[i] as TcxDbCheckBox ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbLookupComboBox ) then begin
      if ( Components[i] as TcxDbLookupComboBox ).Properties.ReadOnly then
        ( Components[i] as TcxDbLookupComboBox ).Style.Color := oColor
      else
        ( Components[i] as TcxDbLookupComboBox ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbImageComboBox ) then begin
      if ( Components[i] as TcxDbImageComboBox ).Properties.ReadOnly then
        ( Components[i] as TcxDbImageComboBox ).Style.Color := oColor
      else
        ( Components[i] as TcxDbImageComboBox ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbCalcEdit ) then begin
      if ( Components[i] as TcxDbCalcEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbCalcEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbCalcEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbSpinEdit ) then begin
      if ( Components[i] as TcxDbSpinEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbSpinEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbSpinEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbCurrencyEdit ) then begin
      if ( Components[i] as TcxDbCurrencyEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbCurrencyEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbCurrencyEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbTimeEdit ) then begin
      if ( Components[i] as TcxDbTimeEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbTimeEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbTimeEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbMemo ) then begin
      if ( Components[i] as TcxDbMemo ).Properties.ReadOnly then
        ( Components[i] as TcxDbMemo ).Style.Color := oColor
      else
        ( Components[i] as TcxDbMemo ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbHyperLinkEdit ) then begin
      if ( Components[i] as TcxDbHyperLinkEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbHyperLinkEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbHyperLinkEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxDbDateEdit ) then begin
      if ( Components[i] as TcxDbDateEdit ).Properties.ReadOnly then
        ( Components[i] as TcxDbDateEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxDbDateEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxMaskEdit ) then begin
      if ( Components[i] as TcxMaskEdit ).Properties.ReadOnly then
        ( Components[i] as TcxMaskEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxMaskEdit ).Style.Color := iColor;
    end;
    if ( Components[i] is TcxSpinEdit ) then begin
      if ( Components[i] as TcxSpinEdit ).Properties.ReadOnly then
        ( Components[i] as TcxSpinEdit ).Style.Color := oColor
      else
        ( Components[i] as TcxSpinEdit ).Style.Color := iColor;
    end;
    //
  end;
end;
Function TfrmTransferenciaPOSV_SAP.Buscar_Pedidos(TipoPedido : String):Boolean;
begin
    qrPedido.Close;
    qrPedido.Sql.Clear;
    qrPedido.SQL.Text := ' Select Seleccionar,U_Numero,GrupoID,ClienteID,NombreCliente,'+
                         ' Case Estado When '+#39+'T'+#39+' Then '+#39+'Abierto'+#39+
                         '             When '+#39+'P'+#39+' Then '+#39+'Pre-Factura'+#39+
                         '             When '+#39+'F'+#39+' Then '+#39+'Facturado'+#39+
                         '             When '+#39+'C'+#39+' Then '+#39+'Cancelado'+#39+' end As Estado,'+
                         ' Case Tipo_Pedido When '+#39+'P'+#39+' Then '+#39+'Pedido de Ventas'+#39+
                         '             When '+#39+'D'+#39+' Then '+#39+'Diario'+#39+
                         '             When '+#39+'S'+#39+' Then '+#39+'Suscripcion'+#39+
                         '             When '+#39+'A'+#39+' Then '+#39+'Articulo Requerido'+#39+' end As Tipo_Pedido,'+
                         '      Fecha_Desde,Fecha_Hasta,Comentario,MonedaID '+
                         ' From PedidoVenta_Head '+
                         ' WHERE Estado = '+ #39 +TipoPedido+ #39;

    qrPedido_Head.Open;
    If qrpedido_Head.RecordCount > 0 then
    begin
       qrPedido_Head.First;
       Result := True;
    end
    else
      Result := False;
End;
Procedure TfrmTransferenciaPOSV_SAP.BorrarPedido2Click(Sender: TObject);
 Var qPedidos           : TAdoQuery;
     ClienteID,Estado   : String;
begin
  inherited;
  If (qrPedido_Head.RecordCount > 0) And
     ((qrPedido_HeadEstado.AsString='Abierto') Or (qrPedido_HeadEstado.AsString='T') Or
      (qrPedido_HeadEstado.AsString='Pre-Factura') Or (qrPedido_HeadEstado.AsString='P')) And
     (qrPedido_HeadSeleccionar.AsBoolean = True) Then
  begin
     If (EtMensajeDlg('Está seguro de eliminar pedido del Cliente '+qrPedido_HeadClienteID.AsString,etConfirmacion,[etSi,etNo],1,dm.Imagenes.Items[5].Bitmap,true) = mryes) then
     begin
         ClienteID:=qrPedido_HeadClienteID.AsString;
         Estado   :=qrPedido_HeadEstado.AsString;
         spMensaje.Visible :=True;
         qPedidos := DM.NewQuery;
         qPedidos.Close;
         qPedidos.SQL.Text := ' Delete [SERSAP].POSInterfaz.dbo.PedidoVentaDetalle '+
                               ' Where Recid in (Select RecID From [SERSAP].POSInterfaz.dbo.PedidoVenta Where ClienteID='+#39+qrPedido_HeadClienteID.AsString+#39+
                               ' And Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime)+#39+
                               ' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime)+#39+')'+
                               ' Delete [SERSAP].POSInterfaz.dbo.PedidoVenta '+
                               ' Where ClienteID='+#39+qrPedido_HeadClienteID.AsString+#39+
                               ' And Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime)+#39+
                               ' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime)+#39+
                               ' Delete [SERSAP].POSInterfaz.dbo.PedidoVenta_Head '+
                               ' Where ClienteID='+#39+qrPedido_HeadClienteID.AsString+#39+
                               ' And Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime)+#39+
                               ' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime)+#39;
          qPedidos.ExecSQL;
          ShowMessage('Pedido del Cliente '+ClienteID+' Eliminado.  Verifique.');
          Buscar_Pedidos(Get_Estado(Estado));
          Buscar_Registro_Primario;
          spMensaje.Visible := False;
     end;
     FreeAndNil(qPedidos);
  end;
end;

procedure TfrmTransferenciaPOSV_SAP.TransferirPedidoSAP1Click(Sender: TObject);
 Var  qPedidos                  : TAdoQuery;
      ClienteID,GrupoID,Estado  : String;
begin
  inherited;
  if qrPedido.RecordCount > 0 then
  begin
     If (EtMensajeDlg('Está seguro de transferir a SAP este Estos Clientes Seleccionados ?',etConfirmacion,[etSi,etNo],1,dm.Imagenes.Items[5].Bitmap,true) = mryes) then
     begin
          ClienteID :=qrPedido_HeadClienteID.Value;
          GrupoID   :=qrPedido_HeadGrupoID.Value;
          Estado    :=qrPedido_HeadEstado.Value;
          spMensaje.Visible :=True;
          qrPedido_Head.First;
          While Not qrPedido_Head.Eof do
          begin
             if qrPedido_HeadSeleccionar.AsBoolean = True then
             begin
               If Not ActPreFacturaSap Then
               begin
                  if qrPedido_HeadClienteID.AsString <> EmptyStr then
                  begin
                    Raise exception.CreateFmt( ' NO Se Pudo Generar la carga del Cliente '+qrPedido_HeadClienteID.AsString+'.'+ #13 +
                                            ' Se Ha Generado Un Error en ActPreFacturaSap. '+ #13 +
                                            ' Por Favor, Intentelo Nuevamente.',[]);
                  end
               end;
               qPedidos := DM.NewQuery;
               qPedidos.Close;
               qPedidos.SQL.Text := ' Update [SERSAP].POSInterfaz.dbo.PedidoVenta_Head '+
                                     ' Set Estado='+#39+'P'+#39+
                                     ' Where ClienteID='+#39+qrPedido_HeadClienteID.AsString+#39+
                                     ' And Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime)+#39+
                                     ' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime)+#39+
                                     ' Update [SERSAP].POSInterfaz.dbo.PedidoVenta '+
                                     ' Set Estado='+#39+'P'+#39+
                                     ' Where ClienteID='+#39+qrPedido_HeadClienteID.AsString+#39+
                                     ' And Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime)+#39+
                                     ' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime)+#39;

               qrPedido_Head.ExecSQL;
             end;
             qrPedido_Head.Next;
          end;
          If qrPedido_HeadClienteID.AsString <> EmptyStr then
              ShowMessage('Proceso Cliente '+ClienteID+' Transferido.  Verifique.');
          Buscar_Pedidos(Get_Estado(Estado));
          Buscar_Registro_Primario;
          spMensaje.Visible := False;
         end;
      FreeAndNil(qPedidos);
    end;
end;

procedure TfrmTransferenciaPOSV_SAP.Buscar_Registro_Primario;
begin
  With qrPedido_Head,sql do
  begin
    if IsEmpty then
    begin
        dsPedidoHead.Enabled := False;
        dsArticulos.Enabled := False;
        exit;
    end
    else
    begin
        dsPedidoHead.Enabled := True;
        dsArticulos.Enabled := True;
    end;
  end;
{  With qrPedido,sql do
  begin
      First;
      DsDatos.Enabled := False;
      if not JvMemoryData1.Active then
         JvMemoryData1.Active := true;
      JvMemoryData1.EmptyTable;
      while not eof do
      begin
            JvMemoryData1.Append;
            JvMemoryData1Seleccionar.AsBoolean    := False;
            JvMemoryData1Pedido_Venta.AsString    := fieldbyname('U_Numero').AsString;
            JvMemoryData1Cuenta_Cliente.AsString  := fieldbyname('ClienteID').AsString;
            JvMemoryData1Nombre.AsString          := fieldbyname('NombreCliente').AsString;
            JvMemoryData1Tipo_Pedido.AsString     := 'Pedido de Venta';
            JvMemoryData1Estado.AsString          := fieldbyname('Estado').AsString;
            JvMemoryData1MonedaID.AsString        := FieldByName('MonedaID').AsString;
            JvMemoryData1Fecha_Inicio.AsDateTime  := FieldByName('Fecha_Desde').AsDateTime;
            JvMemoryData1Fecha_Fin.AsDateTime     := FieldByName('Fecha_Hasta').AsDateTime;
            JvMemoryData1ClienteID_Gen.AsString   := FieldByName('ClienteID_Gen').AsString;
            JvMemoryData1GrupoID_Gen.AsString     := FieldByName('GrupoID_Gen').AsString;
            Next;
      end;
  End;
  }
  qrPedido_Head.First;
  dsPedidoHead.Enabled := True;
  If qrPedido_Head.recordset.recordcount > 0 then
  begin
      qrPedido_Head.First;
      If (qrPedido_HeadEstado.AsString = 'Abierto') Or
         (qrPedido_HeadEstado.AsString = 'T') Or
         (qrPedido_HeadEstado.AsString = 'Pre-Factura') Or
         (qrPedido_HeadEstado.AsString = 'P') Then
      begin
        BorrarPedido1.Enabled :=True;
        TransferirPedidoSAP1.Enabled := True;
        cxGrid2DBTableView2.OptionsData.Editing := True;
      end
      else
      begin
        BorrarPedido1.Enabled :=False;
        TransferirPedidoSAP1.Enabled := False;
        cxGrid2DBTableView2.OptionsData.Editing := False;
      end;
{     DsDatos.Enabled := True;
      With qrPedido,sql do
      begin
          Close;
          SQL.Text := ' Select RecId,ClienteID,Muestrano,Case Estado When '+#39+'T'+#39+' Then '+#39+'Abierto'+#39+
                      '                                                     When '+#39+'P'+#39+' Then '+#39+'Pre-Factura'+#39+
                      '                                                     When '+#39+'F'+#39+' Then '+#39+'Facturado'+#39+
                      '                                                     When '+#39+'C'+#39+' Then '+#39+'Cancelado'+#39+' end As Estado,MonedaID,U_Numero,NombreCliente,Fecha_Desde,Fecha_Hasta,ClienteID_Gen,GrupoID_Gen,Comentario From dbo.PedidoVenta '+
                      ' Where ClienteID='+#39+qrPedidoClienteID.AsString+#39+' And  Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedidoFecha_Desde.AsDateTime)+#39+' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedidoFecha_Hasta.AsDateTime)+#39;

          Open;
          if IsEmpty then
          begin
            exit;
          end;
          First;
      end;
}
      If qrPedido_Head.Recordset.RecordCount > 0 then
      begin
        With qrPedidoDetalle do
        begin
            Close;
            SQL.Text := ' Select * From dbo.PedidoVentaDetalle '+
                        ' Where RecID in ( Select RecID from dbo.PedidoVenta Where ClienteID='+#39+qrPedido_HeadClienteID.AsString+#39+' And  Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime)+#39+' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime)+#39+')';
            Open;
            If Recordset.RecordCount > 0 then First;
          End;
      End;
    end;
end;
procedure TfrmTransferenciaPOSV_SAP.CancelarAgregarUsuario1Click(
  Sender: TObject);
begin
  inherited;
{ if JvMemoryData2.IsEmpty then
   begin
      JvMemoryData2.Active := true;
      JvMemoryData2.EmptyTable;
   end;
   JvMemoryData2.Cancel;
   cxGrid2DBTableView2.OptionsView.NewItemRow := False;
 }
 if qrPedidoDetalle.IsEmpty then
   begin
      qrPedidoDetalle.Active := true;
      qrPedidoDetalle.Delete;
   end;
   qrPedidoDetalle.Cancel;
   cxGrid2DBTableView2.OptionsView.NewItemRow := False;
end;

procedure TfrmTransferenciaPOSV_SAP.cboEstadoPropertiesChange(Sender: TObject);
begin
  inherited;
    if cboEstado.Text = '' then
    begin
          Seleccion    := ' Select Seleccionar,U_Numero,GrupoID,ClienteID,NombreCliente,'+
                         ' Case Estado When '+#39+'T'+#39+' Then '+#39+'Abierto'+#39+
                         '             When '+#39+'P'+#39+' Then '+#39+'Pre-Factura'+#39+
                         '             When '+#39+'F'+#39+' Then '+#39+'Facturado'+#39+
                         '             When '+#39+'C'+#39+' Then '+#39+'Cancelado'+#39+' end As Estado,'+
                         ' Case Tipo_Pedido When '+#39+'P'+#39+' Then '+#39+'Pedido de Ventas'+#39+
                         '             When '+#39+'D'+#39+' Then '+#39+'Diario'+#39+
                         '             When '+#39+'S'+#39+' Then '+#39+'Suscripcion'+#39+
                         '             When '+#39+'A'+#39+' Then '+#39+'Articulo Requerido'+#39+' end As Tipo_Pedido,'+
                         '      Fecha_Desde,Fecha_Hasta,Comentario,MonedaID '+
                         ' From PedidoVenta_Head ';
    end
    else if cboEstado.Text = 'Abierto' then
    begin
          Seleccion    := ' Select Seleccionar,U_Numero,GrupoID,ClienteID,NombreCliente,'+
                         ' Case Estado When '+#39+'T'+#39+' Then '+#39+'Abierto'+#39+
                         '             When '+#39+'P'+#39+' Then '+#39+'Pre-Factura'+#39+
                         '             When '+#39+'F'+#39+' Then '+#39+'Facturado'+#39+
                         '             When '+#39+'C'+#39+' Then '+#39+'Cancelado'+#39+' end As Estado,'+
                         ' Case Tipo_Pedido When '+#39+'P'+#39+' Then '+#39+'Pedido de Ventas'+#39+
                         '             When '+#39+'D'+#39+' Then '+#39+'Diario'+#39+
                         '             When '+#39+'S'+#39+' Then '+#39+'Suscripcion'+#39+
                         '             When '+#39+'A'+#39+' Then '+#39+'Articulo Requerido'+#39+' end As Tipo_Pedido,'+
                         '      Fecha_Desde,Fecha_Hasta,Comentario,MonedaID '+
                         ' From PedidoVenta_Head '+
                       ' Where Estado = '+ #39 + 'T' + #39 ;
          cxGrid2DBTableView2.OptionsData.Editing := True;
    end
    else if cboEstado.Text = 'Pre-Factura' then
    begin
          Seleccion    := ' Select Seleccionar,U_Numero,GrupoID,ClienteID,NombreCliente,'+
                         ' Case Estado When '+#39+'T'+#39+' Then '+#39+'Abierto'+#39+
                         '             When '+#39+'P'+#39+' Then '+#39+'Pre-Factura'+#39+
                         '             When '+#39+'F'+#39+' Then '+#39+'Facturado'+#39+
                         '             When '+#39+'C'+#39+' Then '+#39+'Cancelado'+#39+' end As Estado,'+
                         ' Case Tipo_Pedido When '+#39+'P'+#39+' Then '+#39+'Pedido de Ventas'+#39+
                         '             When '+#39+'D'+#39+' Then '+#39+'Diario'+#39+
                         '             When '+#39+'S'+#39+' Then '+#39+'Suscripcion'+#39+
                         '             When '+#39+'A'+#39+' Then '+#39+'Articulo Requerido'+#39+' end As Tipo_Pedido,'+
                         '      Fecha_Desde,Fecha_Hasta,Comentario,MonedaID '+
                         ' From PedidoVenta_Head '+
                       ' Where Estado = '+ #39 + 'P' + #39 ;
      cxGrid2DBTableView2.OptionsData.Editing := False;
    end
    else if cboEstado.Text = 'Facturado' then
    begin
          Seleccion    := ' Select Seleccionar,U_Numero,GrupoID,ClienteID,NombreCliente,'+
                         ' Case Estado When '+#39+'T'+#39+' Then '+#39+'Abierto'+#39+
                         '             When '+#39+'P'+#39+' Then '+#39+'Pre-Factura'+#39+
                         '             When '+#39+'F'+#39+' Then '+#39+'Facturado'+#39+
                         '             When '+#39+'C'+#39+' Then '+#39+'Cancelado'+#39+' end As Estado,'+
                         ' Case Tipo_Pedido When '+#39+'P'+#39+' Then '+#39+'Pedido de Ventas'+#39+
                         '             When '+#39+'D'+#39+' Then '+#39+'Diario'+#39+
                         '             When '+#39+'S'+#39+' Then '+#39+'Suscripcion'+#39+
                         '             When '+#39+'A'+#39+' Then '+#39+'Articulo Requerido'+#39+' end As Tipo_Pedido,'+
                         '      Fecha_Desde,Fecha_Hasta,Comentario,MonedaID '+
                         ' From PedidoVenta_Head '+
                       ' Where Estado = '+ #39 + 'F' + #39;
      cxGrid2DBTableView2.OptionsData.Editing := True;
    end
    else if cboEstado.Text = 'Cancelado' then
    begin
          Seleccion    := ' Select Seleccionar,U_Numero,GrupoID,ClienteID,NombreCliente,'+
                         ' Case Estado When '+#39+'T'+#39+' Then '+#39+'Abierto'+#39+
                         '             When '+#39+'P'+#39+' Then '+#39+'Pre-Factura'+#39+
                         '             When '+#39+'F'+#39+' Then '+#39+'Facturado'+#39+
                         '             When '+#39+'C'+#39+' Then '+#39+'Cancelado'+#39+' end As Estado,'+
                         ' Case Tipo_Pedido When '+#39+'P'+#39+' Then '+#39+'Pedido de Ventas'+#39+
                         '             When '+#39+'D'+#39+' Then '+#39+'Diario'+#39+
                         '             When '+#39+'S'+#39+' Then '+#39+'Suscripcion'+#39+
                         '             When '+#39+'A'+#39+' Then '+#39+'Articulo Requerido'+#39+' end As Tipo_Pedido,'+
                         '      Fecha_Desde,Fecha_Hasta,Comentario,MonedaID '+
                         ' From PedidoVenta_Head '+
                         ' Where Estado = '+ #39 + 'C' + #39;
      cxGrid2DBTableView2.OptionsData.Editing := True;
    end;
    With qrPedido_Head,sql do
    begin
        Close;
        Sql.Text := Seleccion;
        Open;
    end;
    Buscar_Registro_Primario;
end;

procedure TfrmTransferenciaPOSV_SAP.cxGrid1DBTableView1CellClick(
  Sender: TcxCustomGridTableView; ACellViewInfo: TcxGridTableDataCellViewInfo;
  AButton: TMouseButton; AShift: TShiftState; var AHandled: Boolean);
  Var Est : String;
begin
  inherited;
    If Length(qrPedido_HeadClienteID.Value) > 0 then
    begin
      With qrPedidoDetalle,sql do
      begin
          Close;
          SQL.Text := ' Select * From dbo.PedidoVentaDetalle '+
                      ' Where RecID in ( Select RecID From PedidoVenta Where '+
                      ' ClienteID='+#39+qrPedido_HeadClienteID.AsString+#39+' And  Fecha_Desde ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime)+#39+' And Fecha_Hasta ='+#39+FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime)+#39+')';
          Open;
            If Recordset.RecordCount > 0 then First;
          End;
          If (qrPedido_HeadEstado.AsString = 'Abierto') Or
             (qrPedido_HeadEstado.AsString = 'T') Or
             (qrPedido_HeadEstado.AsString = 'P') Or
             (qrPedido_HeadEstado.AsString = 'Pre-Factura') then
          begin
            BorrarPedido1.Enabled :=True;
            cxGrid2DBTableView2.OptionsData.Editing := True;
            TransferirPedidoSAP1.Enabled := True;
          end
          else
          begin
            BorrarPedido1.Enabled :=False;
            cxGrid2DBTableView2.OptionsData.Editing := False;
            TransferirPedidoSAP1.Enabled := False;
          end;
    end;
end;
procedure TfrmTransferenciaPOSV_SAP.DesmarcarTodosRegistros1Click(
  Sender: TObject);
begin
  inherited;
  if qrPedido_Head.RecordCount > 0 then
  begin
        spMensaje.Visible :=True;
        qrPedido_Head.First;
        While Not qrPedido_Head.Eof do
        begin
            qrPedido_Head.Edit;
            qrPedido_HeadSeleccionar.AsBoolean:= False;
            qrPedido_Head.Post;
           qrPedido_Head.Next;
        end;
        qrPedido_Head.First;
        qrPedido_Head.Refresh;
        spMensaje.Visible :=False;
  end;
end;

function TfrmTransferenciaPOSV_SAP.ActPreFacturaSap : Boolean;
begin
Result := False;
Try
  with  dm.ActPreFacturaSap, Parameters do
  begin
    ParamByName('@GrupoID').Value         := ' ';
    ParamByName('@ClienteID').Value       := qrPedido_HeadClienteID.AsString;
    ParamByName('@FechaInicial').Value    := FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Desde.AsDateTime);
    ParamByName('@FechaFinal').Value      := FormatDateTime('yyyymmdd', qrPedido_HeadFecha_Hasta.AsDateTime);
    ExecProc;
    Result:= True;
  end;
  Except
    On E : Exception do
      ShowMessage(E.Message);
  End
end;
function TfrmTransferenciaPOSV_SAP.Busca_RecID(ClienteID : String; Estado: String) : Int64;
Var qconsulta : TADOQuery;
begin
   qconsulta := DM.NewQuery;
   With qconsulta, sql do
   begin
      Close;
      Text := ' Select Top 1 RecID from [SERSAP].PosInterfaz.dbo.PedidoVenta '+#13+
              ' Where Estado = '+#39+Estado+#39+' And ClienteID='#39+ClienteID+#39;
      Open;
   end;
  if (qconsulta.RecordCount > 0) then
    result := qconsulta.FieldByName('RecID').Value
  else
    result := 0;
  FreeAndNil(qconsulta);
end;
function TfrmTransferenciaPOSV_SAP.Get_Estado(Estado : String) : String;
Var Est : String;
begin
   result := EmptyStr;
   Est:=Estado;
   if Estado='Abierto' then Est:='T'
   else If Estado='Pre-Factura' then Est:='P'
   else If Estado='Facturado' then Est:='F'
   else If Estado='Cancelado' then Est:='C';
   if Length(Est)=1 then
      Result:=Est
   else
      Result:=Estado;
end;


END.

